# Oracle Schema Fixes

This document tracks important Oracle schema fixes that have been applied to prevent future build issues.

## ERROR_LOG Table Schema Fix

### Issue
The ERROR_LOG table had a data type mismatch that caused `ORA-00932: inconsistent datatypes: expected NUMBER got BINARY` errors.

### Root Cause
- **Table Creation** (in `realtime-cdc.service.ts`): Originally created `ERROR_ID` as `NUMBER GENERATED BY DEFAULT AS IDENTITY`
- **Error Handler** (in `error-handler-consumer.service.ts`): Tries to insert `SYS_GUID()` (returns RAW/BINARY) into ERROR_ID

### Fix Applied
Updated the table creation in `realtime-cdc.service.ts` to use:
```sql
CREATE TABLE ERROR_LOG (
  ERROR_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,  -- Changed from NUMBER to RAW(16)
  ORIGINAL_TOPIC VARCHAR2(255),
  ERROR_MESSAGE CLOB,
  ERROR_TYPE VARCHAR2(100),                         -- Added missing column
  PROCESSING_ATTEMPTS NUMBER,                       -- Added missing column
  ORIGINAL_MESSAGE CLOB,                           -- Added missing column
  ERROR_TIMESTAMP TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  CALL_ID VARCHAR2(50),
  CREATED_AT TIMESTAMP DEFAULT SYSDATE             -- Added missing column
)
```

### Files Modified
1. `api/src/services/realtime-cdc.service.ts` - Updated ERROR_LOG table creation and added KAFKA_PERMANENT_FAILURES table
2. `api/src/services/consumers/error-handler-consumer.service.ts` - Added documentation comments

### Validation
- ✅ No more `ORA-00932` datatype errors
- ✅ Error handler can successfully log errors to Oracle
- ✅ All required columns are present in table creation

### Prevention
- Added cross-references in code comments between the two files
- This document serves as a reminder for future schema changes
- Always ensure table schema matches the INSERT queries that use it

## CDC Processing Log Infinite Loop Prevention

### Issue
System experienced recurring infinite loops and constraint violations requiring manual fixes 3+ times:
- **Infinite Loop**: Same call IDs processed every minute due to Kafka offset commit failures
- **Constraint Violations**: `ORA-00001: unique constraint violations` in CDC_PROCESSING_LOG

### Root Causes Identified
1. **CDC_PROCESSING_LOG Duplicates**: INSERT operations trying to insert same CHANGE_ID multiple times
2. **Circuit Breaker Trips**: Kafka consumer group rebalancing causing repeated processing
3. **No Preventive Maintenance**: Manual cleanup required after each issue

### Permanent Fixes Implemented

#### 1. **CDC Processing Log MERGE Fix** (`realtime-cdc.service.ts`)
```sql
-- OLD (caused duplicates):
INSERT INTO CDC_PROCESSING_LOG (CHANGE_ID, ...) VALUES (:changeId, ...)

-- NEW (prevents duplicates):
MERGE INTO CDC_PROCESSING_LOG USING DUAL ON (CHANGE_ID = :changeId)
WHEN NOT MATCHED THEN INSERT (CHANGE_ID, ...) VALUES (:changeId, ...)
```

#### 2. **Pre-Test Cleanup** (`run-international-call-test.sh`)
- Automatically clears CDC_PROCESSING_LOG before tests
- Resets circuit breakers proactively
- Prevents issues before they occur

#### 3. **System Health Check** (`system-health-check.sh`)
- Automated preventive maintenance script
- Checks CDC logs, circuit breakers, consumer lag
- Can be run independently: `./system-health-check.sh`

### Prevention Strategy
- **Before Tests**: Run `./system-health-check.sh`
- **Weekly Maintenance**: Clear CDC logs automatically
- **Monitoring**: Check consumer lag and circuit breaker status
- **Code Fix**: MERGE prevents constraint violations permanently

### Files Modified
- `api/src/services/realtime-cdc.service.ts` - MERGE statement fix and KAFKA_PERMANENT_FAILURES table creation
- `run-international-call-test.sh` - Pre-test cleanup
- `system-health-check.sh` - New preventive maintenance script
- `ORACLE_SCHEMA_FIXES.md` - This documentation

### Validation
- ✅ No more manual CDC log clearing needed
- ✅ Constraint violations prevented by MERGE
- ✅ Circuit breakers reset automatically
- ✅ Proactive issue prevention

## KAFKA_PERMANENT_FAILURES Table Fix

### Issue
Error handler consumer failed with `ORA-00942: table or view does not exist` when trying to log permanent failures after retry exhaustion.

### Root Cause
The `KAFKA_PERMANENT_FAILURES` table was not being created automatically during system startup, causing crashes in error handling.

### Fix Applied
Added automatic table creation in `realtime-cdc.service.ts` during CDC initialization:
```sql
CREATE TABLE KAFKA_PERMANENT_FAILURES (
  FAILURE_ID RAW(16) DEFAULT SYS_GUID() PRIMARY KEY,
  ORIGINAL_TOPIC VARCHAR2(255),
  ERROR_MESSAGE CLOB,
  ERROR_TYPE VARCHAR2(100),
  TOTAL_ATTEMPTS NUMBER,
  ORIGINAL_MESSAGE CLOB,
  FIRST_ERROR_TIMESTAMP TIMESTAMP,
  MARKED_FAILED_AT TIMESTAMP DEFAULT SYSDATE
)
```

### Validation
- ✅ Table created automatically on every restart
- ✅ Error handler can log permanent failures without crashes
- ✅ No more `ORA-00942` errors in error processing

---
Generated: 2025-08-23 (Fixed during system integration testing)
Updated: 2025-08-23 (Added permanent prevention fixes)